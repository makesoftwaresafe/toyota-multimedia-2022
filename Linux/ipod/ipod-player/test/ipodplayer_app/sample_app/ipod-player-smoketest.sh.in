#!/bin/bash

################################################################################
# This source code is proprietary of ADIT
# Copyright (C) Advanced Driver Information Technology GmbH
# All rights reserved
################################################################################

################################################################################
#
# --- AUTOMATED SMOKETEST ---
#
# Description:  This test checks ipod player
# Group:        smartphone,ipod
# Arch NOK:
# Board OK:
# Board NOK:
# Reset:        0
# Timeout:      60
# Check:        audio-play
# Host-Pre:
# Host-Post:
#
################################################################################

DIR=$(dirname $0)
source "${DIR}/smoketest.func" || exit 1
source "${DIR}/ipod-auth.func" || FN_smoketest_error "Sourcing '${DIR}/ipod-auth.func' failed."

# initialize smoketest
FN_smoketest_init || FN_smoketest_error "Smoketest init failed."

# load audio functionality
FN_smoketest_use "audio" || FN_smoketest_error "Use audio functionality failed."

# load dlt functionality
FN_smoketest_use "dlt" || FN_smoketest_error "Use dlt functionality failed."

# define test variables
TEST_SERVICE1="iap2_service.service"
TEST_SERVICE2="ipod-player.service"
TEST_USER="${1:-root}"

################################################################################

echo ${SMOKETEST_DELIMITER}
echo "iPOD player test - Expected Result:"
echo "  iPod attached, AppleAuthChip working, tracks listed, TRACEs visible in DLT"
echo "  hearable sound of Track#1 (Play(3s)->Pause(3s)->Play(3s)->Pause(3s)->Play)"
echo

# initialize ipod environment
FN_ipod_startup || FN_smoketest_error "IPOD startup failed."

FN_check_user "${TEST_USER}"

# check USB port and vbus off/on
if [ "${SMOKETEST_FAMILY}" == "mx6q" ] || [ "${SMOKETEST_FAMILY}" == "gr-mrb-64" ] || [ "${SMOKETEST_FAMILY}" == "rcar-gen3" ]; then
  FN_user_execute "${TEST_USER}" "@CMAKE_INSTALL_PREFIX@/bin/ipod-device_check  1> ${SMOKETEST_LOG_FILE}"
fi
# start and check for low layer service
FN_start_service "${TEST_SERVICE1}"
FN_active_service "${TEST_SERVICE1}"

# start and check for active test service
FN_start_service "${TEST_SERVICE2}"
FN_active_service "${TEST_SERVICE2}"

# start recording
FN_audio_start_record

echo "Running IPOD sample app ..."
FN_user_execute "${TEST_USER}" "@CMAKE_INSTALL_PREFIX@/bin/ipod-sample_app >> ${SMOKETEST_LOG_FILE} 2>&1"

echo "Check cleaned IPOD-PLAYER ..."
# get all ipod processes exlcuding grep, the smoketest and process of test service
ps auxw | grep -i ipod | grep -v grep | grep -v ${SMOKETEST_NAME} | grep -v iPodPlayerCore.out

echo "Check for AppleAuthChip ..."
grep Connection=1 ${SMOKETEST_LOG_FILE} | grep -q "Authentication = 1,"
if [ "$?" != "0" ]; then
  grep Connection=1 ${SMOKETEST_LOG_FILE} | grep -q "Authentication = 2,"

  if [ "$?" != "0" ]; then
    FN_smoketest_error "No AppleAuthChip found - check '${SMOKETEST_LOG_FILE}'."
  fi
fi

echo "Check for OTG port ..."
grep "INFO: Device Connected to Native OTG port." ${SMOKETEST_LOG_FILE}
if [ "$?" != "0" ]; then
  FN_smoketest_error "No Apple device connected to OTG Port - check '${SMOKETEST_LOG_FILE}'."
fi

echo "Device information ..."
grep -i "Device name" ${SMOKETEST_LOG_FILE}
grep -i "serial name" ${SMOKETEST_LOG_FILE}

echo "Track information ..."
grep -i -q "trackIndex=0: Name" ${SMOKETEST_LOG_FILE} || FN_smoketest_error "No tracks listed - check '${SMOKETEST_LOG_FILE}'."

# print number of tracks
echo "  $(grep -i 'trackIndex=' ${SMOKETEST_LOG_FILE} | wc -l) tracks found"

FN_audio_stop_record

# finalize ipod environment
FN_ipod_exit

FN_smoketest_result "0" "User '${TEST_USER}' tested."

